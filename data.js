// === アトラクションタグ定義（API取得後に上書きされる） ===
var ATTRACTION_TAGS = {};

// === パスデータ（API取得後に上書きされる） ===
var PASSES = [];

// === データ取得完了フラグ ===
var PASS_DATA_LOADED = false;

// === 予告パスデータ（API取得後に上書きされる） ===
var UPCOMING_PASSES = [];

// === フォールバック用アトラクションタグ定義 ===
var FALLBACK_ATTRACTION_TAGS = {
  donkey: "ドンキーコング・トロッコ",
  mario: "マリオカート",
  yoshi: "ヨッシー・アドベンチャー",
  harrypotter: "ハリー・ポッター",
  dinosaur: "フライングダイナソー",
  hollywood: "ハリウッド・ドリーム（バックドロップ含む）",
  minion: "ミニオン系",
  jaws: "ジョーズ",
  jurassic: "ジュラシック・パーク・ザ・ライド",
  theater: "シアター系（4-Dなど）",
  any: "特にこだわりなし"
};

// === フォールバック用全16パスデータ（API障害時に使用） ===
var FALLBACK_PASSES = [
  // 1. プレミアム
  {
    id: "premium",
    name: "ユニバーサル・エクスプレス・パス\n〜プレミアム〜",
    shortName: "プレミアム",
    type: "premium",
    color: "#FFD700",
    colorBg: "#FFF8E1",
    borderColor: "#FFD700",
    minHeight: 132,
    areaEntry: ["nintendo", "harrypotter"],
    attractions: {
      fixed: [
        "ドンキーコングのクレイジー・トロッコ",
        "マリオカート〜クッパの挑戦状〜",
        "ヨッシー・アドベンチャー",
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー",
        "フライト・オブ・ザ・ヒッポグリフ",
        "ザ・フライング・ダイナソー",
        "ハリウッド・ドリーム〜バックドロップ〜",
        "ハリウッド・ドリーム・ザ・ライド",
        "シング・オン・ツアー",
        "スペース・ファンタジー・ザ・ライド",
        "ミニオン・ハチャメチャ・ミッション",
        "ミニオン・ハチャメチャ・ライド",
        "名探偵コナン 4-D ライブ・ショー",
        "ジュラシック・パーク・ザ・ライド"
      ],
      selectable1: [],
      selectable2: []
    },
    tags: ["donkey", "mario", "yoshi", "harrypotter", "dinosaur", "hollywood", "minion", "jurassic", "theater"],
    description: "全14アトラクションを網羅する最強パス。ニンテンドーエリアもウィザーディング・ワールドも入場確約付き。",
    advice: "「全部乗りたい！」という方に最適。混雑日はこれ一択で、1日を丸ごと満喫できます。",
    timeDesignated: [],
    pricing: {
      "2026-03-22": 57400, "2026-03-23": 61600, "2026-03-24": 57400,
      "2026-03-25": 65800, "2026-03-31": 52500,
      "2026-04-01": 57000, "2026-04-02": 57000, "2026-04-03": 57000,
      "2026-04-04": 52500,
      "2026-04-05": 48000, "2026-04-06": 48000, "2026-04-07": 48000,
      "2026-04-08": 48000, "2026-04-09": 48000, "2026-04-10": 48000,
      "2026-04-11": 48000, "2026-04-12": 48000, "2026-04-13": 48000,
      "2026-04-14": 48000, "2026-04-15": 48000
    }
  },
  // 2. エクスプレス・パス 7 トロッコ＆セレクション
  {
    id: "ep7_trolley_selection",
    name: "エクスプレス・パス 7\n〜トロッコ＆セレクション〜",
    shortName: "エクスプレス・パス 7 トロッコ＆セレクション",
    type: "ep7",
    color: "#4A90D9",
    colorBg: "#EBF3FB",
    borderColor: "#4A90D9",
    minHeight: 122,
    areaEntry: ["nintendo", "harrypotter"],
    attractions: {
      fixed: [
        "ドンキーコングのクレイジー・トロッコ",
        "マリオカート〜クッパの挑戦状〜",
        "ヨッシー・アドベンチャー",
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー",
        "フライト・オブ・ザ・ヒッポグリフ"
      ],
      selectable1: ["ザ・フライング・ダイナソー", "ミニオン・ハチャメチャ・ライド"],
      selectable2: ["ジョーズ", "ジュラシック・パーク・ザ・ライド"]
    },
    tags: ["donkey", "mario", "yoshi", "harrypotter", "dinosaur", "minion", "jurassic"],
    description: "人気7アトラクションを厳選。両エリア入場確約付きで、主要アトラクションをしっかり押さえられます。",
    advice: "迷ったらコレ！コスパと満足度のバランスが一番良い定番チョイスです。",
    timeDesignated: [],
    pricing: {
      "2026-03-01": 23800, "2026-03-02": 23800, "2026-03-03": 23800,
      "2026-03-04": 25800, "2026-03-05": 23800,
      "2026-03-08": 23800, "2026-03-09": 25800, "2026-03-10": 23800,
      "2026-03-11": 25800, "2026-03-12": 25800,
      "2026-03-14": 25800, "2026-03-15": 25800, "2026-03-16": 27800,
      "2026-03-20": 29800, "2026-03-21": 29800,
      "2026-03-22": 29800, "2026-03-23": 31800, "2026-03-24": 29800,
      "2026-03-25": 31800, "2026-03-26": 31800, "2026-03-27": 31800,
      "2026-03-28": 29800,
      "2026-04-04": 25800, "2026-04-05": 23800,
      "2026-04-11": 23800, "2026-04-12": 23800, "2026-04-13": 23800,
      "2026-04-14": 23800, "2026-04-15": 23800
    }
  },
  // 3. エクスプレス・パス 4 ミニオン＆ハリウッド・ドリーム
  {
    id: "ep4_minion_hollywood",
    name: "エクスプレス・パス 4\n〜ミニオン＆ハリウッド・ドリーム・ザ・ライド〜",
    shortName: "エクスプレス・パス 4 ミニオン＆ハリウッド・ドリーム",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 122,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "ドンキーコングのクレイジー・トロッコ",
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー",
        "ミニオン・ハチャメチャ・ライド"
      ],
      selectable1: ["ハリウッド・ドリーム・ザ・ライド", "ジョーズ"],
      selectable2: []
    },
    tags: ["donkey", "harrypotter", "minion", "hollywood"],
    description: "ドンキーコング＋ハリポタ＋ミニオンの人気3つに加え、ハリウッド・ドリームかジョーズを選べるパス。",
    advice: "絶叫系もミニオンも両方楽しみたい大人グループにおすすめ。",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "ドンキーコングのクレイジー・トロッコ"],
    pricing: {
      "2026-03-01": 16800, "2026-03-04": 18800,
      "2026-03-07": 18800, "2026-03-08": 16800,
      "2026-03-10": 16800, "2026-03-11": 18800, "2026-03-12": 18800,
      "2026-03-13": 16800, "2026-03-14": 18800, "2026-03-15": 18800,
      "2026-03-17": 18800, "2026-03-18": 16800, "2026-03-19": 18800,
      "2026-03-21": 24800, "2026-03-22": 22800, "2026-03-23": 24800,
      "2026-03-24": 22800, "2026-03-25": 26800, "2026-03-26": 24800,
      "2026-03-27": 26800, "2026-03-28": 22800,
      "2026-03-29": 18800, "2026-03-30": 18800, "2026-03-31": 18800,
      "2026-04-01": 20800, "2026-04-02": 20800, "2026-04-03": 20800,
      "2026-04-04": 18800,
      "2026-04-05": 16800, "2026-04-06": 16800, "2026-04-07": 16800,
      "2026-04-08": 16800, "2026-04-09": 16800, "2026-04-10": 16800,
      "2026-04-11": 16800, "2026-04-12": 16800, "2026-04-13": 16800,
      "2026-04-14": 16800, "2026-04-15": 16800
    }
  },
  // 4. エクスプレス・パス 4 レース＆トロッコ
  {
    id: "ep4_race_trolley",
    name: "エクスプレス・パス 4\n〜レース＆トロッコ〜",
    shortName: "エクスプレス・パス 4 レース＆トロッコ",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 122,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "ドンキーコングのクレイジー・トロッコ",
        "マリオカート〜クッパの挑戦状〜",
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー"
      ],
      selectable1: ["ザ・フライング・ダイナソー", "ジョーズ"],
      selectable2: []
    },
    tags: ["donkey", "mario", "harrypotter", "dinosaur"],
    description: "ドンキーコング＋マリオカート＋ハリポタの鉄板3つ。フライングダイナソーかジョーズも選べます。",
    advice: "ニンテンドーエリア入場確約付き。ドンキーコング＋マリオカートの鉄板コンボです。",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "マリオカート〜クッパの挑戦状〜", "ドンキーコングのクレイジー・トロッコ"],
    pricing: {
      "2026-03-02": 16800, "2026-03-04": 18800, "2026-03-05": 18800,
      "2026-03-07": 18800, "2026-03-08": 16800,
      "2026-03-09": 18800, "2026-03-10": 16800,
      "2026-03-11": 18800, "2026-03-12": 18800,
      "2026-03-14": 18800, "2026-03-15": 18800, "2026-03-16": 20800,
      "2026-03-17": 18800, "2026-03-19": 18800,
      "2026-03-21": 24800, "2026-03-22": 22800, "2026-03-23": 24800,
      "2026-03-24": 22800, "2026-03-25": 26800, "2026-03-26": 24800,
      "2026-03-27": 26800, "2026-03-28": 22800, "2026-03-31": 18800
    }
  },
  // 5. エクスプレス・パス 4 トロッコ＆ジョーズ
  {
    id: "ep4_trolley_jaws",
    name: "エクスプレス・パス 4\n〜トロッコ＆ジョーズ〜",
    shortName: "エクスプレス・パス 4 トロッコ＆ジョーズ",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 122,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "ドンキーコングのクレイジー・トロッコ",
        "マリオカート〜クッパの挑戦状〜"
      ],
      selectable1: ["ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー", "ザ・フライング・ダイナソー"],
      selectable2: ["ジョーズ", "ジュラシック・パーク・ザ・ライド"]
    },
    tags: ["donkey", "mario", "harrypotter", "dinosaur", "jurassic"],
    description: "ドンキーコング＋マリオカートに加え、ハリポタorダイナソー、ジョーズorジュラシックを選べる自由度の高いパス。",
    advice: "選択肢が多いので、事前に乗りたいものを決めておくとスムーズです。",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "マリオカート〜クッパの挑戦状〜", "ドンキーコングのクレイジー・トロッコ"],
    pricing: {
      "2026-03-02": 16800, "2026-03-07": 18800, "2026-03-08": 16800,
      "2026-03-11": 18800, "2026-03-12": 18800,
      "2026-03-16": 20800, "2026-03-17": 18800, "2026-03-19": 18800,
      "2026-03-21": 24800, "2026-03-22": 22800, "2026-03-23": 24800,
      "2026-03-24": 22800, "2026-03-25": 26800, "2026-03-26": 24800,
      "2026-03-27": 26800, "2026-03-28": 22800, "2026-03-31": 18800,
      "2026-04-01": 20800, "2026-04-02": 20800, "2026-04-03": 20800,
      "2026-04-04": 18800,
      "2026-04-05": 16800, "2026-04-11": 16800, "2026-04-12": 16800,
      "2026-04-13": 16800, "2026-04-15": 16800
    }
  },
  // 6. エクスプレス・パス 4 レース＆ジョーズ
  {
    id: "ep4_race_jaws",
    name: "エクスプレス・パス 4\n〜レース＆ジョーズ〜",
    shortName: "エクスプレス・パス 4 レース＆ジョーズ",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 122,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "マリオカート〜クッパの挑戦状〜",
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー",
        "ミニオン・ハチャメチャ・ライド"
      ],
      selectable1: ["ジョーズ", "ジュラシック・パーク・ザ・ライド"],
      selectable2: []
    },
    tags: ["mario", "harrypotter", "minion", "jurassic"],
    description: "マリオカート＋ハリポタ＋ミニオンの人気3つ。ジョーズかジュラシック・パークも選べます。",
    advice: "ニンテンドーエリア入場確約付き。子連れにも人気のバランス型パス。",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "マリオカート〜クッパの挑戦状〜"],
    pricing: {
      "2026-03-02": 16800, "2026-03-03": 16800, "2026-03-04": 18800,
      "2026-03-05": 16800, "2026-03-08": 16800,
      "2026-03-09": 18800, "2026-03-10": 16800, "2026-03-11": 18800,
      "2026-03-12": 18800, "2026-03-13": 16800, "2026-03-14": 18800,
      "2026-03-17": 18800, "2026-03-19": 18800,
      "2026-03-16": 20800,
      "2026-03-20": 26800, "2026-03-21": 24800,
      "2026-03-22": 22800, "2026-03-23": 24800, "2026-03-24": 22800,
      "2026-03-25": 26800, "2026-03-26": 24800, "2026-03-27": 26800,
      "2026-03-29": 18800,
      "2026-04-01": 20800, "2026-04-02": 20800, "2026-04-03": 20800,
      "2026-04-04": 18800,
      "2026-04-05": 16800, "2026-04-07": 16800, "2026-04-08": 16800,
      "2026-04-09": 16800, "2026-04-10": 16800, "2026-04-11": 16800,
      "2026-04-12": 16800, "2026-04-13": 16800, "2026-04-14": 16800,
      "2026-04-15": 16800
    }
  },
  // 7. エクスプレス・パス 4 フライング・ダイナソー＆4-D
  {
    id: "ep4_dino_4d",
    name: "エクスプレス・パス 4\n〜フライング・ダイナソー＆4-D〜",
    shortName: "エクスプレス・パス 4 フラダイ＆4-D",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 132,
    areaEntry: [],
    attractions: {
      fixed: [
        "呪術廻戦・ザ・リアル 4-D ～廻る時計台～",
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー",
        "フライト・オブ・ザ・ヒッポグリフ",
        "ザ・フライング・ダイナソー"
      ],
      selectable1: [],
      selectable2: []
    },
    tags: ["harrypotter", "dinosaur", "theater"],
    description: "ダイナソー＋ハリポタ＋ヒッポグリフ＋呪術4-D。全4つ固定で選択不要の絶叫系パス。",
    advice: "エリア入場確約なし。ウィザーディング・ワールドは朝イチか夕方に行きましょう。",
    timeDesignated: ["フライト・オブ・ザ・ヒッポグリフ", "呪術廻戦・ザ・リアル 4-D ～廻る時計台～"],
    pricing: {
      "2026-03-21": 17800, "2026-03-22": 17800, "2026-03-23": 19800,
      "2026-03-24": 17800, "2026-03-25": 21800, "2026-03-26": 19800,
      "2026-03-27": 21800, "2026-03-28": 15800,
      "2026-03-29": 13800, "2026-03-30": 13800, "2026-03-31": 13800,
      "2026-04-01": 15800, "2026-04-02": 15800, "2026-04-03": 15800,
      "2026-04-04": 13800,
      "2026-04-05": 11800, "2026-04-06": 11800, "2026-04-07": 11800,
      "2026-04-08": 11800, "2026-04-10": 11800,
      "2026-04-12": 11800, "2026-04-13": 11800, "2026-04-14": 11800,
      "2026-04-15": 11800
    }
  },
  // 8. エクスプレス・パス 4 ミニオン＆アドベンチャー
  {
    id: "ep4_minion_adventure",
    name: "エクスプレス・パス 4\n〜ミニオン＆アドベンチャー〜",
    shortName: "エクスプレス・パス 4 ミニオン＆アドベンチャー",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 102,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "ミニオン・ハチャメチャ・ミッション",
        "ミニオン・ハチャメチャ・ライド",
        "ヨッシー・アドベンチャー",
        "名探偵コナン 4-D ライブ・ショー"
      ],
      selectable1: [],
      selectable2: []
    },
    tags: ["minion", "yoshi", "theater"],
    description: "ミニオン2つ＋ヨッシー＋コナン4-D。102cm以上でOK、小さなお子さまも楽しめます。",
    advice: "絶叫系なし。102cm以上から全部乗れるので、小さなお子さま連れファミリーに最適！",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "ヨッシー・アドベンチャー", "ミニオン・ハチャメチャ・ミッション"],
    pricing: {
      "2026-03-01": 12800, "2026-03-02": 12800, "2026-03-03": 12800,
      "2026-03-04": 14800, "2026-03-05": 12800, "2026-03-06": 12800,
      "2026-03-07": 14800, "2026-03-08": 12800,
      "2026-03-09": 14800, "2026-03-10": 12800, "2026-03-11": 14800,
      "2026-03-12": 14800, "2026-03-13": 12800,
      "2026-03-15": 14800, "2026-03-16": 16800,
      "2026-03-17": 14800, "2026-03-18": 12800, "2026-03-19": 14800,
      "2026-03-21": 20800, "2026-03-22": 18800, "2026-03-23": 20800,
      "2026-03-24": 18800, "2026-03-25": 22800, "2026-03-26": 20800,
      "2026-03-27": 24800, "2026-03-28": 18800,
      "2026-03-29": 14800, "2026-03-30": 14800, "2026-03-31": 14800
    }
  },
  // 9. エクスプレス・パス 4 スペファン＆ミニオンHM
  {
    id: "ep4_space_minion_mission",
    name: "エクスプレス・パス 4\n〜スペース・ファンタジー＆ミニオン・ハチャメチャ・ミッション〜",
    shortName: "エクスプレス・パス 4 スペファン＆ミニオンHM",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 102,
    areaEntry: [],
    attractions: {
      fixed: [
        "呪術廻戦・ザ・リアル 4-D ～廻る時計台～",
        "ミニオン・ハチャメチャ・ミッション",
        "スペース・ファンタジー・ザ・ライド"
      ],
      selectable1: ["ジョーズ", "ジュラシック・パーク・ザ・ライド"],
      selectable2: []
    },
    tags: ["minion", "theater", "jurassic"],
    description: "スペース・ファンタジー＋ミニオン・ミッション＋4-D。ジョーズかジュラシックも選べます。",
    advice: "ニンテンドーエリアのアトラクションは含まれません。エリアには朝イチで行きましょう。",
    timeDesignated: ["呪術廻戦・ザ・リアル 4-D ～廻る時計台～", "ミニオン・ハチャメチャ・ミッション"],
    pricing: {
      "2026-03-01": 11800, "2026-03-02": 11800, "2026-03-03": 11800,
      "2026-03-04": 13800, "2026-03-05": 11800, "2026-03-06": 11800,
      "2026-03-07": 13800, "2026-03-08": 11800,
      "2026-03-09": 13800, "2026-03-10": 11800, "2026-03-11": 13800,
      "2026-03-12": 13800, "2026-03-13": 11800,
      "2026-03-14": 13800, "2026-03-15": 13800, "2026-03-16": 15800,
      "2026-03-17": 13800, "2026-03-18": 11800, "2026-03-19": 13800,
      "2026-03-20": 19800, "2026-03-21": 17800,
      "2026-03-22": 17800, "2026-03-23": 19800,
      "2026-03-24": 17800, "2026-03-25": 21800, "2026-03-26": 19800,
      "2026-03-27": 21800, "2026-03-28": 17800,
      "2026-03-29": 13800, "2026-03-30": 13800, "2026-03-31": 13800,
      "2026-04-01": 15800, "2026-04-02": 15800, "2026-04-03": 15800,
      "2026-04-04": 13800,
      "2026-04-05": 11800, "2026-04-06": 11800, "2026-04-07": 11800,
      "2026-04-08": 11800, "2026-04-09": 11800, "2026-04-10": 11800,
      "2026-04-11": 11800, "2026-04-12": 11800, "2026-04-13": 11800,
      "2026-04-14": 11800, "2026-04-15": 11800
    }
  },
  // 10. エクスプレス・パス 4 スペファン＆ミニオン
  {
    id: "ep4_space_minion",
    name: "エクスプレス・パス 4\n〜スペース・ファンタジー＆ミニオン〜",
    shortName: "エクスプレス・パス 4 スペファン＆ミニオン",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 102,
    areaEntry: [],
    attractions: {
      fixed: [
        "呪術廻戦・ザ・リアル 4-D ～廻る時計台～",
        "スペース・ファンタジー・ザ・ライド"
      ],
      selectable1: ["ミニオン・ハチャメチャ・ライド", "名探偵コナン 4-D ライブ・ショー"],
      selectable2: ["ジョーズ", "ジュラシック・パーク・ザ・ライド"]
    },
    tags: ["minion", "theater", "jurassic"],
    description: "スペース・ファンタジー＋4-D。ミニオンかコナン、ジョーズかジュラシックを選べます。",
    advice: "選択肢が多く自由度が高い。お手頃価格で楽しみたい方に。",
    timeDesignated: ["呪術廻戦・ザ・リアル 4-D ～廻る時計台～"],
    pricing: {
      "2026-03-01": 11800, "2026-03-02": 11800, "2026-03-03": 11800,
      "2026-03-04": 13800, "2026-03-05": 11800, "2026-03-06": 11800,
      "2026-03-07": 13800, "2026-03-08": 11800,
      "2026-03-09": 13800, "2026-03-10": 11800, "2026-03-11": 13800,
      "2026-03-12": 13800, "2026-03-13": 11800,
      "2026-03-14": 13800, "2026-03-15": 13800, "2026-03-16": 15800,
      "2026-03-17": 13800, "2026-03-18": 11800, "2026-03-19": 13800,
      "2026-03-20": 19800, "2026-03-21": 17800,
      "2026-03-22": 17800, "2026-03-23": 19800,
      "2026-03-24": 17800, "2026-03-25": 21800, "2026-03-26": 19800,
      "2026-03-27": 21800, "2026-03-28": 17800,
      "2026-03-29": 13800, "2026-03-30": 13800, "2026-03-31": 13800,
      "2026-04-01": 15800, "2026-04-02": 15800, "2026-04-03": 15800,
      "2026-04-04": 13800,
      "2026-04-05": 11800, "2026-04-06": 11800, "2026-04-07": 11800,
      "2026-04-08": 11800, "2026-04-09": 11800, "2026-04-10": 11800,
      "2026-04-11": 11800, "2026-04-12": 11800, "2026-04-13": 11800,
      "2026-04-14": 11800, "2026-04-15": 11800
    }
  },
  // 11. エクスプレス・パス 4 フラダイ＆ジュラパ
  {
    id: "ep4_dino_jurassic",
    name: "エクスプレス・パス 4\n〜フライング・ダイナソー＆ジュラシック・パーク〜",
    shortName: "エクスプレス・パス 4 フラダイ＆ジュラパ",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 122,
    areaEntry: [],
    attractions: {
      fixed: [
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー",
        "フライト・オブ・ザ・ヒッポグリフ"
      ],
      selectable1: ["ザ・フライング・ダイナソー", "スペース・ファンタジー・ザ・ライド"],
      selectable2: ["ジョーズ", "ジュラシック・パーク・ザ・ライド"]
    },
    tags: ["harrypotter", "dinosaur", "jurassic"],
    description: "ハリポタエリア2つ＋ダイナソーorスペファン＋ジョーズorジュラシック。絶叫系＆冒険系パス。",
    advice: "ハリポタと絶叫系を両方楽しみたい方に。ニンテンドーエリアは朝イチで。",
    timeDesignated: ["フライト・オブ・ザ・ヒッポグリフ"],
    pricing: {
      "2026-03-01": 11800, "2026-03-02": 11800, "2026-03-03": 11800,
      "2026-03-04": 13800, "2026-03-05": 11800, "2026-03-06": 11800,
      "2026-03-07": 13800, "2026-03-08": 11800,
      "2026-03-09": 13800, "2026-03-10": 11800, "2026-03-11": 13800,
      "2026-03-12": 13800, "2026-03-13": 11800,
      "2026-03-14": 13800, "2026-03-15": 13800, "2026-03-16": 15800,
      "2026-03-17": 13800, "2026-03-18": 11800, "2026-03-19": 13800,
      "2026-03-20": 17800, "2026-03-21": 17800,
      "2026-03-22": 17800, "2026-03-23": 19800,
      "2026-03-24": 17800, "2026-03-25": 21800, "2026-03-26": 19800,
      "2026-03-27": 23800, "2026-03-28": 17800,
      "2026-03-29": 13800, "2026-03-30": 13800, "2026-03-31": 13800,
      "2026-04-01": 15800, "2026-04-02": 15800, "2026-04-03": 15800,
      "2026-04-04": 13800,
      "2026-04-05": 11800, "2026-04-06": 11800, "2026-04-07": 11800,
      "2026-04-08": 11800, "2026-04-09": 11800, "2026-04-10": 11800,
      "2026-04-11": 11800, "2026-04-12": 11800, "2026-04-13": 11800,
      "2026-04-14": 11800, "2026-04-15": 11800
    }
  },
  // 12. エクスプレス・パス 4 アドベンチャー＆レース
  {
    id: "ep4_adventure_race",
    name: "エクスプレス・パス 4\n〜アドベンチャー＆レース〜",
    shortName: "エクスプレス・パス 4 アドベンチャー＆レース",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 122,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "マリオカート〜クッパの挑戦状〜",
        "ヨッシー・アドベンチャー",
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー",
        "ミニオン・ハチャメチャ・ライド"
      ],
      selectable1: [],
      selectable2: []
    },
    tags: ["mario", "yoshi", "harrypotter", "minion"],
    description: "マリオカート＋ヨッシー＋ハリポタ＋ミニオン。選択制なしの安心パス。",
    advice: "全て確定アトラクションで迷わない。ニンテンドーエリア入場確約付き！",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "マリオカート〜クッパの挑戦状〜", "ヨッシー・アドベンチャー"],
    pricing: {
      "2026-03-02": 14800, "2026-03-03": 14800, "2026-03-04": 16800,
      "2026-03-05": 14800, "2026-03-07": 16800, "2026-03-08": 14800,
      "2026-03-09": 16800, "2026-03-10": 14800, "2026-03-11": 16800,
      "2026-03-12": 16800, "2026-03-13": 14800,
      "2026-03-14": 16800, "2026-03-15": 16800, "2026-03-16": 18800,
      "2026-03-17": 16800, "2026-03-18": 14800, "2026-03-19": 16800,
      "2026-03-20": 24800, "2026-03-21": 22800,
      "2026-03-22": 20800, "2026-03-23": 22800,
      "2026-03-24": 20800, "2026-03-25": 24800, "2026-03-26": 22800,
      "2026-03-27": 26800, "2026-03-28": 20800, "2026-03-31": 16800
    }
  },
  // 13. エクスプレス・パス 4 トロッコ＆ジュラシック・パーク
  {
    id: "ep4_trolley_jurassic",
    name: "エクスプレス・パス 4\n〜トロッコ＆ジュラシック・パーク〜",
    shortName: "エクスプレス・パス 4 トロッコ＆ジュラパ",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 107,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "ドンキーコングのクレイジー・トロッコ",
        "ヨッシー・アドベンチャー",
        "ミニオン・ハチャメチャ・ライド"
      ],
      selectable1: ["ジョーズ", "ジュラシック・パーク・ザ・ライド"],
      selectable2: []
    },
    tags: ["donkey", "yoshi", "minion", "jurassic"],
    description: "ドンキーコング＋ヨッシー＋ミニオン。ジョーズかジュラシックも選べます。",
    advice: "107cm以上から乗れるので、子連れでもドンキーコングを楽しめます！",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "ヨッシー・アドベンチャー", "ドンキーコングのクレイジー・トロッコ"],
    pricing: {
      "2026-03-02": 16800, "2026-03-03": 16800, "2026-03-04": 18800,
      "2026-03-05": 16800, "2026-03-08": 16800,
      "2026-03-09": 18800, "2026-03-10": 16800, "2026-03-11": 18800,
      "2026-03-12": 18800, "2026-03-13": 16800,
      "2026-03-14": 18800, "2026-03-17": 18800, "2026-03-19": 18800,
      "2026-03-16": 20800,
      "2026-03-20": 26800, "2026-03-21": 24800,
      "2026-03-22": 22800, "2026-03-23": 24800,
      "2026-03-24": 22800, "2026-03-25": 26800, "2026-03-26": 24800,
      "2026-03-27": 26800, "2026-03-29": 18800,
      "2026-04-01": 20800, "2026-04-02": 20800, "2026-04-03": 20800,
      "2026-04-04": 18800,
      "2026-04-05": 16800, "2026-04-07": 16800, "2026-04-08": 16800,
      "2026-04-09": 16800, "2026-04-10": 16800, "2026-04-11": 16800,
      "2026-04-12": 16800, "2026-04-13": 16800, "2026-04-14": 16800,
      "2026-04-15": 16800
    }
  },
  // 14. エクスプレス・パス 4 ミニオン＆シアター（4月限定）
  {
    id: "ep4_minion_theater",
    name: "エクスプレス・パス 4\n〜ミニオン＆シアター〜",
    shortName: "エクスプレス・パス 4 ミニオン＆シアター",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 102,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "ヨッシー・アドベンチャー",
        "ミニオン・ハチャメチャ・ライド",
        "ミニオン・ハチャメチャ・ミッション"
      ],
      selectable1: ["ジョーズ", "名探偵コナン 4-D ライブ・ショー"],
      selectable2: []
    },
    tags: ["yoshi", "minion", "theater"],
    description: "ヨッシー＋ミニオン2つ。ジョーズかコナン4-Dも選べる、小さなお子さま向けパス。",
    advice: "102cm以上でOK。小さなお子さまと一緒でも安心して楽しめます。",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "ヨッシー・アドベンチャー", "ミニオン・ハチャメチャ・ミッション"],
    pricing: {
      "2026-04-01": 16800, "2026-04-02": 16800, "2026-04-03": 16800,
      "2026-04-04": 14800,
      "2026-04-05": 12800, "2026-04-06": 12800, "2026-04-07": 12800,
      "2026-04-08": 12800, "2026-04-09": 12800, "2026-04-10": 12800,
      "2026-04-11": 12800, "2026-04-12": 12800, "2026-04-13": 12800,
      "2026-04-14": 12800, "2026-04-15": 12800
    }
  },
  // 15. エクスプレス・パス 4 レース＆シアター（4月限定）
  {
    id: "ep4_race_theater",
    name: "エクスプレス・パス 4\n〜レース＆シアター〜",
    shortName: "エクスプレス・パス 4 レース＆シアター",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 122,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "マリオカート〜クッパの挑戦状〜",
        "ヨッシー・アドベンチャー",
        "ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー"
      ],
      selectable1: ["ミニオン・ハチャメチャ・ライド", "名探偵コナン 4-D ライブ・ショー"],
      selectable2: []
    },
    tags: ["mario", "yoshi", "harrypotter", "minion", "theater"],
    description: "マリオカート＋ヨッシー＋ハリポタ。ミニオンかコナン4-Dも選べます。",
    advice: "ニンテンドーエリア入場確約付き。人気どころをバランスよく押さえたパス。",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "マリオカート〜クッパの挑戦状〜", "ヨッシー・アドベンチャー"],
    pricing: {
      "2026-04-01": 18800, "2026-04-02": 18800, "2026-04-03": 18800,
      "2026-04-04": 16800,
      "2026-04-05": 14800, "2026-04-06": 14800, "2026-04-07": 14800,
      "2026-04-10": 14800, "2026-04-11": 14800, "2026-04-12": 14800,
      "2026-04-13": 14800, "2026-04-14": 14800, "2026-04-15": 14800
    }
  },
  // 16. エクスプレス・パス 4 バックドロップ＆レース（4月限定）
  {
    id: "ep4_backdrop_race",
    name: "エクスプレス・パス 4\n〜バックドロップ＆レース〜",
    shortName: "エクスプレス・パス 4 バックドロップ＆レース",
    type: "ep4",
    color: "#27AE60",
    colorBg: "#E8F8EF",
    borderColor: "#27AE60",
    minHeight: 132,
    areaEntry: ["nintendo"],
    attractions: {
      fixed: [
        "マリオカート〜クッパの挑戦状〜",
        "スペース・ファンタジー・ザ・ライド",
        "ハリウッド・ドリーム〜バックドロップ〜"
      ],
      selectable1: ["ハリー・ポッター・アンド・ザ・フォービドゥン・ジャーニー", "ザ・フライング・ダイナソー"],
      selectable2: []
    },
    tags: ["mario", "hollywood", "harrypotter", "dinosaur"],
    description: "マリオカート＋バックドロップ＋スペファン。ハリポタかダイナソーも選べる絶叫系パス。",
    advice: "絶叫系を攻めたい方に。ニンテンドーエリア入場確約付き！",
    timeDesignated: ["スーパー・ニンテンドー・ワールド入場", "マリオカート〜クッパの挑戦状〜"],
    pricing: {
      "2026-04-01": 18800, "2026-04-02": 18800, "2026-04-03": 18800,
      "2026-04-04": 16800,
      "2026-04-05": 14800, "2026-04-06": 14800, "2026-04-07": 14800,
      "2026-04-08": 14800, "2026-04-09": 14800, "2026-04-10": 14800,
      "2026-04-11": 14800, "2026-04-12": 14800, "2026-04-13": 14800,
      "2026-04-14": 14800, "2026-04-15": 14800
    }
  }
];

// === レコメンドアルゴリズム ===
function calculateResult(date, height, attractionTags, budget) {
  // Step 1: 日付フィルタ
  var available = PASSES.filter(function (p) {
    return p.pricing[date] !== undefined;
  });

  if (available.length === 0) {
    return { main: null, others: [], heightWarning: false };
  }

  // Step 2: 身長フィルタ（ソフトフィルタ）
  var heightWarning = false;
  var heightFiltered = available.filter(function (p) {
    return height >= p.minHeight;
  });

  if (heightFiltered.length === 0) {
    // 身長で全パスが除外される場合 → フィルタ解除して警告フラグ
    heightWarning = true;
  } else {
    available = heightFiltered;
  }

  // Step 3: アトラクションマッチスコア
  var hasAny = attractionTags.indexOf("any") !== -1;

  var scored = available.map(function (p) {
    var matchScore = 0;
    if (hasAny) {
      matchScore = 1;
    } else {
      attractionTags.forEach(function (tag) {
        if (p.tags.indexOf(tag) !== -1) {
          matchScore++;
        }
      });
    }

    // Step 4: 予算スコア
    var price = p.pricing[date];
    var budgetScore = 0;

    if (budget === "time") {
      // お金より時間: 高価格パスほど高スコア
      if (p.type === "premium") budgetScore = 5;
      else if (p.type === "ep7") budgetScore = 3;
      else budgetScore = 1;
    } else if (budget === "balance") {
      // コスパよく: 中価格帯に高スコア
      if (p.type === "ep7") budgetScore = 4;
      else if (p.type === "ep4" && p.areaEntry.length > 0) budgetScore = 3;
      else if (p.type === "ep4") budgetScore = 2;
      else budgetScore = 1;
    } else {
      // 節約: 低価格パスほど高スコア
      if (price <= 15000) budgetScore = 5;
      else if (price <= 20000) budgetScore = 3;
      else if (price <= 25000) budgetScore = 1;
      else budgetScore = 0;
    }

    // Step 5: 総合スコア
    var totalScore = matchScore * 3 + budgetScore;

    return {
      pass: p,
      matchScore: matchScore,
      budgetScore: budgetScore,
      totalScore: totalScore,
      price: price
    };
  });

  // matchScore=0 のパスは除外（こだわりなし以外）
  if (!hasAny) {
    scored = scored.filter(function (s) {
      return s.matchScore > 0;
    });
  }

  if (scored.length === 0) {
    // フィルタで全滅した場合、元のリストから予算だけでスコアリング
    scored = available.map(function (p) {
      var price = p.pricing[date];
      var budgetScore = 0;
      if (budget === "save") {
        budgetScore = price <= 15000 ? 5 : price <= 20000 ? 3 : 1;
      } else if (budget === "balance") {
        budgetScore = p.type === "ep7" ? 4 : 2;
      } else {
        budgetScore = p.type === "premium" ? 5 : p.type === "ep7" ? 3 : 1;
      }
      return { pass: p, matchScore: 0, budgetScore: budgetScore, totalScore: budgetScore, price: price };
    });
  }

  // スコア降順ソート（同点ならep7>ep4>premium順でコスパ重視）
  var typeOrder = { ep7: 0, ep4: 1, premium: 2 };
  scored.sort(function (a, b) {
    if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
    var orderA = typeOrder[a.pass.type] !== undefined ? typeOrder[a.pass.type] : 3;
    var orderB = typeOrder[b.pass.type] !== undefined ? typeOrder[b.pass.type] : 3;
    return orderA - orderB;
  });

  // 上位3件を返す
  return {
    main: scored[0] || null,
    others: scored.slice(1, 3),
    heightWarning: heightWarning
  };
}
